@page "/create-order"
@using WholeLottaDeliveries.Models
@using WholeLottaDeliveries.Services
@attribute [Authorize(Roles = "User")]
@inject OrderService OrderService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Create Order - Delivery App</PageTitle>

<div class="page-header">
    <h2>Create New Order</h2>
</div>

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success">@successMessage</div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-error">@errorMessage</div>
}

<div class="form-container">
    <EditForm Model="orderModel" OnValidSubmit="HandleCreateOrder" FormName="CreateOrderForm">
        <DataAnnotationsValidator />
        
        <div class="form-group">
            <label for="description">Order Description</label>
            <InputTextArea id="description" @bind-Value="orderModel.Description" class="form-control" rows="4" placeholder="e.g., K50 for 2L Milk and K5 for a pen" />
            <ValidationMessage For="@(() => orderModel.Description)" />
        </div>

        <div class="form-group">
            <label for="location">Delivery Location</label>
            <InputSelect id="location" @bind-Value="orderModel.Location" class="form-control">
                <option value="">-- Select Location --</option>
                <option value="Town">Town</option>
                <option value="VML Market">VML Market</option>
                <option value="Campus">Campus</option>
                <option value="Mukuba Mall">Mukuba Mall</option>
            </InputSelect>
            <ValidationMessage For="@(() => orderModel.Location)" />
        </div>

        <div class="form-group">
            <label for="estimatedTime">Time Needed (e.g., 2:30 PM)</label>
            <InputText id="estimatedTime" type="time" @bind-Value="orderModel.EstimatedTime" class="form-control" />
            <ValidationMessage For="@(() => orderModel.EstimatedTime)" />
        </div>

        <div class="form-group">
            <label for="instructions">Delivery Instructions (Optional)</label>
            <InputTextArea id="instructions" @bind-Value="orderModel.DeliveryInstructions" class="form-control" rows="3" placeholder="e.g., Call when you arrive, Room 2 Block A" />
            <ValidationMessage For="@(() => orderModel.DeliveryInstructions)" />
        </div>

        @if (!string.IsNullOrEmpty(orderModel.Location))
        {
            <div class="delivery-fee-display">
                <strong>Estimated Delivery Fee:</strong> @($"K{orderModel.GetDeliveryFee():0.00}")
            </div>
        }

        <div class="form-actions">
            <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner"></span>
                    <span>Submitting...</span>
                }
                else
                {
                    <span>Submit Order</span>
                }
            </button>
            <a href="/dashboard" class="btn btn-secondary">Cancel</a>
        </div>
    </EditForm>
</div>

@code {
    [SupplyParameterFromForm]
    private OrderModel orderModel { get; set; } = new();
    
    private string? successMessage;
    private string? errorMessage;
    private bool isSubmitting = false;

    private async Task HandleCreateOrder()
    {
        isSubmitting = true;
        errorMessage = null;
        
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(userId))
        {
            errorMessage = "User not found. Please log in again.";
            isSubmitting = false;
            return;
        }

        var (success, error) = await OrderService.CreateOrderAsync(userId, orderModel);

        if (success)
        {
            successMessage = "Order created successfully!";
            orderModel = new();
            await Task.Delay(2000);
            Navigation.NavigateTo("/dashboard");
        }
        else
        {
            errorMessage = error;
            isSubmitting = false;
        }
    }
}
